name: Build UbuntuCalc ISO (24.04 Slim, fixed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y debootstrap squashfs-tools xorriso grub-pc-bin grub-efi-amd64-bin mtools genisoimage

      - name: Build minimal Ubuntu rootfs
        run: |
          set -e
          sudo rm -rf build
          mkdir -p build/chroot
          sudo debootstrap --arch=amd64 noble build/chroot http://archive.ubuntu.com/ubuntu/

          # 创建用户与基本配置
          echo "user:x:1000:1000:user,,,:/home/user:/bin/bash" | sudo tee build/chroot/etc/passwd > /dev/null
          echo "user:x:1000:" | sudo tee build/chroot/etc/group > /dev/null
          echo "user:user" | sudo chroot build/chroot chpasswd
          sudo chroot build/chroot usermod -aG sudo user

          # 配置自动登录 lightdm
          sudo chroot build/chroot bash -c '
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
              systemd-sysv lightdm mate-desktop-environment-core mate-terminal mate-calc xorg sudo network-manager
            mkdir -p /etc/lightdm
            echo "[Seat:*]
autologin-user=user
autologin-user-timeout=0
user-session=mate" > /etc/lightdm/lightdm.conf
            mkdir -p /etc/xdg/autostart
            echo "[Desktop Entry]
Type=Application
Name=LinuxCalc
Exec=mate-calc && systemctl poweroff
X-GNOME-Autostart-enabled=true" > /etc/xdg/autostart/linuxcalc.desktop
            apt-get clean
          '

      - name: Create live filesystem
        run: |
          mkdir -p build/image/{casper,boot/grub,isolinux}
          sudo mksquashfs build/chroot build/image/casper/filesystem.squashfs -e boot
          echo "UbuntuCalc 24.04 Slim" | sudo tee build/image/casper/README > /dev/null
          (cd build/chroot && sudo find . | sudo tee ../image/casper/filesystem.manifest) || true
          echo -n $(sudo du -sx --block-size=1 build/chroot | cut -f1) | sudo tee build/image/casper/filesystem.size

          # 复制内核与 initrd
          sudo cp build/chroot/boot/vmlinuz-* build/image/casper/vmlinuz || true
          sudo cp build/chroot/boot/initrd.img-* build/image/casper/initrd || true

          # 创建 grub.cfg
          cat <<EOF | sudo tee build/image/boot/grub/grub.cfg
set default=0
set timeout=5
menuentry "Start UbuntuCalc 24.04 Slim" {
    linux /casper/vmlinuz boot=casper quiet splash ---
    initrd /casper/initrd
}
EOF

          # 生成 ISO
          sudo grub-mkrescue -o ubuntu-calc-24.04-slim.iso build/image

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-calc-24.04-slim
          path: ubuntu-calc-24.04-slim.iso
